<!DOCTYPE html>
<html lang="en">

<head>
            <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="">
        <meta name="author" content="Krzysztof Żuraw">


        <title>Archives from memory- libarchive</title>

            <link href="https://krzysztofzuraw.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Krzysztof Żuraw Full Atom Feed" />
            <link href="https://krzysztofzuraw.com/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="Krzysztof Żuraw RSS Feed" />
            <link href="https://krzysztofzuraw.com/feeds/blog.atom.xml" type="application/atom+xml" rel="alternate" title="Krzysztof Żuraw Categories Atom Feed" />
        <!-- Bootstrap Core CSS -->
        <link href="https://krzysztofzuraw.com/theme/css/bootstrap.min.css" rel="stylesheet">

        <!-- Custom CSS -->
        <link href="https://krzysztofzuraw.com/theme/css/clean-blog.min.css" rel="stylesheet">

        <!-- Code highlight color scheme -->
            <link href="https://krzysztofzuraw.com/theme/css/code_blocks/monokai.css" rel="stylesheet">


        <!-- Custom Fonts -->
        <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->



        <meta name="description" content="How to create archive from files in memory">

        <meta name="author" content="Krzysztof Żuraw">

        <meta name="tags" content="python">

	                <meta property="og:locale" content="en_US.utf8">
		<meta property="og:site_name" content="Krzysztof Żuraw">

	<meta property="og:type" content="article">
            <meta property="article:author" content="Krzysztof Żuraw" >
	<meta property="og:url" content="https://krzysztofzuraw.com/blog/2016/archives-from-memory.html">
	<meta property="og:title" content="Archives from memory- libarchive">
	<meta property="article:published_time" content="2016-09-25 09:00:00+02:00">
            <meta property="og:description" content="How to create archive from files in memory">

            <meta property="og:image" content="https://krzysztofzuraw.com//images/covers/archive.jpg">
            <meta name="twitter:card" content="summary_large_image" />
            <meta name="twitter:image" content="/images/covers/archive.jpg">
        <meta name="twitter:site" content="@krzysztof_zuraw" />
        <meta name="twitter:title" content="Archives from memory- libarchive" />
            <meta name="twitter:description" content="How to create archive from files in memory" />
            <meta name="twitter:image" content="https://krzysztofzuraw.com//images/covers/archive.jpg">
</head>

<body>

    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="https://krzysztofzuraw.com/">Krzysztof Żuraw</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">

                        <li><a href="/pages/about.html">About</a></li>
                        <li><a href="/archives.html">Archive</a></li>
                        <li><a href="/tags.html">Tags</a></li>
                        <li><a href="http://feeds.feedburner.com/krzysztofzuraw">RSS Feed</a></li>
                        <li><a href="https://feedburner.google.com/fb/a/mailverify?uri=krzysztofzuraw&amp;loc=en_US">Email Updates</a></li>


                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

    <!-- Page Header -->
        <header class="intro-header" style="background-image: url('/images/covers/archive.jpg')">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <div class="post-heading">
                        <h1 >Archives from memory- libarchive</h1>
                            <h3 class="subheading" >How to create archive from files in memory</h3>
                        <span class="meta">Posted on Sun 25 September 2016
                        </span>
                        
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
    <!-- Post Content -->
    <!-- TOC -->

    <article>
        <p><strong>This blog post is about python wrapper around libarchive and how to use it to
generate archive from memory.</strong></p>
<div class="contents topic" id="table-of-contents">
<p class="topic-title first">Table of Contents:</p>
<ul class="simple">
<li><a class="reference internal" href="#libarchive-python-libarchive-c" id="id1">Libarchive &amp; python-libarchive-c</a></li>
<li><a class="reference internal" href="#add-entry-from-memory" id="id2">Add entry from memory</a></li>
</ul>
</div>
<div class="section" id="libarchive-python-libarchive-c">
<h2><a class="toc-backref" href="#id1">Libarchive &amp; python-libarchive-c</a></h2>
<p>If you happen to learn more about how to create archives in various formats like
tar, iso or zip I bet you heard about <a class="reference external" href="http://www.libarchive.org/">libarchive</a>. It
is widely used archive library written in C.</p>
<p>To use it within python you can choose from a few libraries but one that is currently
maintained is called <a class="reference external" href="https://github.com/Changaco/python-libarchive-c">python-libarchive-c</a>.
When in my work I was to implement the feature of adding entries to archive from memory
I decided to use existing module and give something back to a community in form of an
open source contribution.</p>
</div>
<div class="section" id="add-entry-from-memory">
<h2><a class="toc-backref" href="#id2">Add entry from memory</a></h2>
<p>To make such a feature I have to reread carefully code examples in libarchive c itself. I
also get familiar with few archive formats and their limitations. But enough talking lets
jump to the code:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">libarchive</span>

<span class="k">def</span> <span class="nf">create_archive_from_memory_file</span><span class="p">():</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;link&#39;</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">libarchive</span><span class="o">.</span><span class="n">file_writer</span><span class="p">(</span><span class="s1">&#39;archive.zip&#39;</span><span class="p">,</span> <span class="s1">&#39;zip&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">archive</span><span class="p">:</span>
        <span class="n">archive</span><span class="o">.</span><span class="n">add_file_from_memory</span><span class="p">(</span>
            <span class="n">entry_path</span><span class="o">=</span><span class="s1">&#39;filename&#39;</span><span class="p">,</span>
            <span class="n">entry_size</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Content-Length&#39;</span><span class="p">]),</span>
            <span class="n">entry_data</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">iter_content</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="mi">1024</span><span class="p">)</span>
        <span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">create_archive_from_memory_file</span><span class="p">()</span>
</pre></div>
<p>My changes in code have not been released so make sure that you install python-libarchive-c
from github like this (to run this script you also need requests library):</p>
<div class="highlight"><pre><span></span>$ pip install git+https://github.com/Changaco/python-libarchive-c
</pre></div>
<p>In this snippet, I use request feature that doesn't require loading the whole content of the response to
memory but instead I add the argument: <tt class="docutils literal">stream=True</tt> and then I use <tt class="docutils literal">response.iter_content(chunk_size=1024)</tt>.
Rest of the code is simply calling <tt class="docutils literal">add_file_from_memory</tt> with a path (<tt class="docutils literal">entry_path</tt>) and size of the entry in
an archive (<tt class="docutils literal">entry_size</tt>).</p>
<p>Under the hood, python-libarchive-c is using <a class="reference external" href="https://docs.python.org/3.5/library/ctypes.html">c_types</a> with
ffi to call libarchive functions. At first, it setup path to entry then sets its size, filetype and permission
which file will be saved in the archive. Then write the header and start iterating through the <tt class="docutils literal">entry_data</tt> by chunks
and write them. At the end, header is set and archive is ready for user.</p>
<p>To see it in action have snippet above as <cite>example.py</cite> and run this script:</p>
<div class="highlight"><pre><span></span>$ python example.py
$ ls -la
-rw-r--r--. <span class="m">1</span> kzuraw kzuraw 11M <span class="m">09</span>-24 <span class="m">13</span>:04 archive.zip
-rw-rw-r--. <span class="m">1</span> kzuraw kzuraw <span class="m">511</span> <span class="m">09</span>-24 <span class="m">12</span>:59 example.py
</pre></div>
<p>That's all for this week. Feel free to comment and if you have any questions don't hesitate to ask them.</p>
<p>Special thanks to Kasia for being editor for this post. Thank you.</p>
<p>Cover image  by <a class="reference external" href="https://commons.wikimedia.org/w/index.php?title=User:Archivo-FSP&amp;action=edit&amp;redlink=1">Archivo-FSP</a> under <a class="reference external" href="https://creativecommons.org/licenses/by-sa/3.0/">CC BY-SA 3.0</a>.</p>
</div>

    </article>

        <div class="tags">
            <p>tags: <a href="https://krzysztofzuraw.com/tag/python.html">python</a>, </p>
        </div>
        <p>If you find this blog post interesting please share:</p>
        <div class="addthis_sharing_toolbox"></div>
        <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-57a7802d9a259bbe"></script>

        <div class="comments">
            <h2>Comments !</h2>
            <div id="disqus_thread"></div>
            <script type="text/javascript">
                var disqus_shortname = 'krzysztofzuraw';
                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = '//krzysztofzuraw.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            </script>
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
            </div>
        </div>
    </div>

    <hr>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <ul class="list-inline text-center">
                            <li>
                                <a href="https://twitter.com/krzysztof_zuraw">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="https://github.com/krzysztofzuraw">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="mailto:krzysztof.zuraw@gmail.com">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="https://pl.linkedin.com/in/krzysztofzuraw">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                    </ul>
<p class="copyright text-muted">
    Blog powered by <a href="http://getpelican.com">Pelican</a>,
    which takes great advantage of <a href="http://python.org">Python</a>.
    This site use cookies for disqus and google analitics.
</p>                </div>
            </div>
        </div>
    </footer>

    <!-- jQuery -->
    <script src="https://krzysztofzuraw.com/theme/js/jquery.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="https://krzysztofzuraw.com/theme/js/bootstrap.min.js"></script>

        <!-- Custom Theme JavaScript -->
        <script src="https://krzysztofzuraw.com/theme/js/clean-blog.min.js"></script>

    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-72188452-2']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
<script type="text/javascript">
    var disqus_shortname = 'krzysztofzuraw';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>

</html>